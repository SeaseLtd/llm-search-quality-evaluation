import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";
import { RatingDetailed } from "@/client";

interface RatingSelectProps {
  rating?: RatingDetailed;
  maxRating: number;
  onChange?: (value: number) => void;
  readonly?: boolean;
  value?: number;
}

const getRating = (rating?: RatingDetailed) => {
  if (!rating) return 0;
  return rating.user_rating ?? rating.llm_rating ?? 0;
};

export default function RatingSelect({
  rating,
  maxRating,
  onChange,
  readonly = false,
  value: providedValue,
}: RatingSelectProps) {
  const value = providedValue !== undefined ? providedValue : getRating(rating);
  const isUserOverridden = rating?.user_rating !== null;

  const getRatingColor = (ratingValue: number) => {
    const percentage = maxRating > 0 ? ratingValue / maxRating : 0;
    if (percentage >= 0.67) return "bg-green-600";
    if (percentage >= 0.33) return "bg-yellow-600";
    return "bg-red-600";
  };

  // Generate rating options dynamically
  const ratingOptions = Array.from({ length: maxRating + 1 }, (_, i) => i);

  // Readonly mode - just display the value
  if (readonly) {
    return (
      <div className="w-12 shrink-0">
        <div className={`${getRatingColor(value)} text-white font-bold rounded px-2 py-1 text-center text-sm`}>
          {value.toFixed(1)}
        </div>
      </div>
    );
  }

  return (
    <div className="w-20 shrink-0">
      <TooltipProvider>
        <Tooltip>
          <TooltipTrigger asChild>
            <div>
              <Select
                value={String(value)}
                onValueChange={(val) => onChange?.(Number(val))}
              >
                <SelectTrigger className={`${getRatingColor(value)} text-white font-bold border-none`}>
                  <SelectValue placeholder={String(value)}>
                    {String(value)}
                  </SelectValue>
                </SelectTrigger>
                <SelectContent>
                  {ratingOptions.map(option => (
                    <SelectItem key={option} value={String(option)}>
                      {option}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </TooltipTrigger>
          {isUserOverridden && rating && (
            <TooltipContent>
              <p>Original rating generated by the LLM: {rating.llm_rating ?? 'N/A'}</p>
            </TooltipContent>
          )}
        </Tooltip>
      </TooltipProvider>
    </div>
  );
}

